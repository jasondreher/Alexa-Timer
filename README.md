# Alexa-Timer
Alexa Timer
Main part of this is in Node red.
'''[{"id":"6a7d13273a282d6b","type":"tab","label":"Alexa Timers","disabled":false,"info":"","env":[]},{"id":"19199c5e19d34757","type":"alexa-remote-event","z":"6a7d13273a282d6b","name":"","account":"afa37006573a75d8","event":"ws-notification-change","x":140,"y":140,"wires":[["a0972b2cda4531bc","3cc2387312f2771c"]]},{"id":"a0972b2cda4531bc","type":"alexa-remote-other","z":"6a7d13273a282d6b","name":"","account":"afa37006573a75d8","config":{"option":"get","value":{"what":"notifications"}},"x":380,"y":140,"wires":[["7efcc1b37b6ada7d"]]},{"id":"861ba23e9c753ed5","type":"function","z":"6a7d13273a282d6b","name":"map timers","func":"const timers = msg.payload.map(x => ({\n   name: x.timerLabel || 'Timer',\n   remaining: x.remainingTime,\n   paused: x.status !== 'ON',\n   deviceSerialNumber: x.deviceSerialNumber,\n}));  \n\nmsg.payload = { \n    timers: timers, \n    time: Date.now() \n};\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":200,"wires":[["89073e82dfee6a53"]]},{"id":"7efcc1b37b6ada7d","type":"function","z":"6a7d13273a282d6b","name":"filter active timers","func":"msg.payload = msg.payload.filter(x => \n    x.type === 'Timer' && x.remainingTime > 0\n);\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":230,"y":200,"wires":[["861ba23e9c753ed5","6e1d1233516911ac"]]},{"id":"95b171875bed909f","type":"ui_template","z":"6a7d13273a282d6b","group":"765c4d0d.672094","name":"Timers","order":1,"width":"0","height":"0","format":"<div id=\"alexa-timers-container\">\n    \n</div>\n<script>\n    (function(scope) {\n        function durationToPieces(dur = 0) {\n        \tconst u = dur % 1000, uRem = Math.floor(dur / 1000);\n        \tconst s = uRem % 60, sRem = Math.floor(uRem / 60);\n        \tconst m = sRem % 60, mRem = Math.floor(sRem / 60);\n        \tconst h = mRem % 24, hRem = Math.floor(mRem / 24);\n        \tconst d = hRem;\n        \treturn [d, h, m, s, u];\n        }\n        \n        function formatDuration(dur) {\n            const [d, h, m, s, u] = durationToPieces(dur);\n            let string = `${m ? String(s).padStart(2, '0') : s}`;\n            if(m) string = `${h ? String(m).padStart(2, '0') : m}:${string}`;\n            if(h) string = `${h}:${string}`;\n            if(d) string = `${d} days ${string}`;\n            return string;\n        }\n\n        scope.$watch('msg.payload', function(data) {\n            const container = $('#alexa-timers-container');\n            container.parent().css({ height: 'auto', width: 'auto', padding: '0', 'overflow-y': 'visible'});\n            container.empty();\n            \n            if(!data) return;\n            console.log(data);\n            const { timers, time } = data;\n            \n            const interval = container.data('interval');\n            if(interval) clearInterval(interval);\n            \n            for (const timer of timers) {\n                // copied from ui_text\n                const row = $('<md-card ui-card-size=\"6x1\" layout=\"row\" layout-align=\"space-between center\" class=\"nr-dashboard-text ng-scope _md layout-row layout-align-space-between-center visible\" style=\"left: 0px; top: 0px; width: 318px; height: 48px;\">');\n                row.css({ margin: '0' });\n                row.data(timer);\n                const label = $(`<p class=\"label\">${timer.name}</p>`);\n                const value = $(`<p class=\"value\">${formatDuration(timer.remaining).toString()}</p>`);\n                const icon = $(`<i class=\"fa fa-${timer.paused ? 'pause' : 'play'}\" style=\"margin-left: 8px;\"></i>`);\n                row.append(label, value.append(icon))\n                container.append(row);\n            }\n            \n            container.data('interval', setInterval(() => {\n                const rows = container.children().each(function(){\n                    const row = $(this);\n                    const timer = row.data();\n                    if(!timer.paused) {\n                        const elapsed = Date.now() - time;\n                        const remaining = Math.max(timer.remaining - elapsed, 0);\n                        //console.log({now: Date.now(), time: time, rem: data.remaining});\n                        const string = formatDuration(remaining);\n                        row.children().eq(1).text(string).append(`<i class=\"fa fa-${timer.paused ? 'pause' : 'play'}\" style=\"margin-left: 8px;\"></i>`);\n                    }\n                });\n                //console.log(rows);  \n            }, 1000));\n        });\n    })(scope);\n</script>","storeOutMessages":true,"fwdInMessages":true,"resendOnRefresh":false,"templateScope":"local","x":710,"y":200,"wires":[["9e631e7b584eb98a"]]},{"id":"cce5affc479714f4","type":"function","z":"6a7d13273a282d6b","name":"Timer 0 time","func":"var topic_string = \"\"\ntopic_string += \"alexa/timer/kitchen_next_timer\";\nmsg.topic =  topic_string;\n\nvar content_string = msg.payload.time + msg.payload.timers[0].remaining;\nmsg.payload = content_string;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":40,"wires":[["9ed84a6900fe463b"]]},{"id":"9ed84a6900fe463b","type":"mqtt out","z":"6a7d13273a282d6b","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"e620c1bc.88c94","x":1130,"y":40,"wires":[]},{"id":"ce2b3652b67261ec","type":"function","z":"6a7d13273a282d6b","name":"Timer 0 name","func":"var topic_string = \"\"\ntopic_string += \"alexa/timer/kitchen_next_timer_name\";\nmsg.topic =  topic_string;\n\nvar content_string =  msg.payload.timers[0].name;\nmsg.payload = content_string;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":80,"wires":[["9c2ebd772f594be4"]]},{"id":"9c2ebd772f594be4","type":"mqtt out","z":"6a7d13273a282d6b","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"e620c1bc.88c94","x":1130,"y":80,"wires":[]},{"id":"45592bc17447af95","type":"function","z":"6a7d13273a282d6b","d":true,"name":"Timer 1 time","func":"var topic_string = \"\"\ntopic_string += \"alexa/timer/kitchen_next_timer3\";\nmsg.topic =  topic_string;\n\nvar content_string = msg.payload.time + msg.payload.timers[1].remaining;\nmsg.payload = content_string;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":460,"wires":[["c8cf49e98802e025"]]},{"id":"c8cf49e98802e025","type":"mqtt out","z":"6a7d13273a282d6b","d":true,"name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"e620c1bc.88c94","x":1130,"y":460,"wires":[]},{"id":"70bcf3d553ed969f","type":"function","z":"6a7d13273a282d6b","d":true,"name":"Timer 1 name","func":"var topic_string = \"\"\ntopic_string += \"alexa/timer/kitchen_next_timer_name3\";\nmsg.topic =  topic_string;\n\nvar content_string =  msg.payload.timers[1].name;\nmsg.payload = content_string;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":520,"wires":[["1e6061e24c8343d1"]]},{"id":"1e6061e24c8343d1","type":"mqtt out","z":"6a7d13273a282d6b","d":true,"name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"e620c1bc.88c94","x":1130,"y":520,"wires":[]},{"id":"89073e82dfee6a53","type":"sort","z":"6a7d13273a282d6b","name":"","order":"ascending","as_num":false,"target":"payload.timers","targetType":"msg","msgKey":"remaining","msgKeyType":"jsonata","seqKey":"payload","seqKeyType":"msg","x":590,"y":240,"wires":[["95b171875bed909f"]]},{"id":"fbda885625ef9417","type":"function","z":"6a7d13273a282d6b","name":"Timer count","func":"var topic_string = \"\"\ntopic_string += \"alexa/timer/alexatimerct\";\nmsg.topic =  topic_string;\n\nvar content_string =  msg.payload.timers.length;\nmsg.payload = content_string;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":970,"y":360,"wires":[["9935baa1ad814406"]]},{"id":"9935baa1ad814406","type":"mqtt out","z":"6a7d13273a282d6b","name":"","topic":"","qos":"","retain":"true","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"e620c1bc.88c94","x":1130,"y":360,"wires":[]},{"id":"e60b12c1.93bb3","type":"inject","z":"6a7d13273a282d6b","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":true,"onceDelay":"15","topic":"","payload":"Started!","payloadType":"str","x":200,"y":60,"wires":[["a0972b2cda4531bc"]]},{"id":"9e631e7b584eb98a","type":"switch","z":"6a7d13273a282d6b","name":"","property":"payload.timers.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":750,"y":260,"wires":[["cce5affc479714f4","ce2b3652b67261ec","45592bc17447af95","70bcf3d553ed969f","fbda885625ef9417","57e4996d31d25ee3","f65181398f53738d","e5ccc9920e2c8e63"],["fbda885625ef9417"]]},{"id":"57e4996d31d25ee3","type":"function","z":"6a7d13273a282d6b","name":"Timer 0 serialnumber","func":"var topic_string = \"\"\ntopic_string += \"alexa/timer/kitchen_next_timer_serialnumber\";\nmsg.topic =  topic_string;\n\nvar content_string = flow.get(\"device_string\");\nmsg.payload = content_string;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":1000,"y":120,"wires":[["e83524f9f17d51eb"]]},{"id":"e83524f9f17d51eb","type":"mqtt out","z":"6a7d13273a282d6b","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"e620c1bc.88c94","x":1130,"y":120,"wires":[]},{"id":"3cc2387312f2771c","type":"alexa-remote-echo","z":"6a7d13273a282d6b","name":"","account":"afa37006573a75d8","config":{"option":"get","value":{"what":"device","device":{"type":"jsonata","value":"payload.deviceSerialNumber"}}},"x":310,"y":340,"wires":[["eeb2ba8865b43dfd","a4ea78cafc56dcac"]]},{"id":"eeb2ba8865b43dfd","type":"debug","z":"6a7d13273a282d6b","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload.accountName","targetType":"msg","statusVal":"","statusType":"auto","x":560,"y":440,"wires":[]},{"id":"a4ea78cafc56dcac","type":"function","z":"6a7d13273a282d6b","name":"","func":"var device\n\ndevice=msg.payload.accountName;\ndevice = device.replace(' ', '_');\n\n\nflow.set('device_string',device);\nreturn msg;\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":500,"y":340,"wires":[[]]},{"id":"f65181398f53738d","type":"function","z":"6a7d13273a282d6b","d":true,"name":"","func":"\nvar datetimedone = new Date( msg.payload.time + msg.payload.timers[0].remaining).toLocaleString(\"en-US\", {hour12: false}).replace(\"/\", \"-\").replace(\"/\", \"-\").replace(\", \", \".\");\nvar content_string = \"http://192.168.0.110:8090/syslog?type=INFO&message=TimeChange.\" + msg.payload.timers[0].name + \".\" + datetimedone + \".\" + msg.payload.timers.length + \"&silent=true\"; \nmsg.payload = content_string;\n\n\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":960,"y":180,"wires":[["70677f0bd6737f88","44047d2813574ab2"]]},{"id":"70677f0bd6737f88","type":"http request","z":"6a7d13273a282d6b","d":true,"name":"","method":"GET","ret":"bin","paytoqs":"ignore","url":"{{{payload}}}","tls":"","persist":false,"proxy":"","authType":"","senderr":false,"x":1150,"y":180,"wires":[[]]},{"id":"e5ccc9920e2c8e63","type":"api-call-service","z":"6a7d13273a282d6b","d":true,"name":"","server":"70b670b8.ae01a","version":1,"debugenabled":false,"service_domain":"switch","service":"turn_on","entityId":"switch.alexatimericon","data":"","dataType":"jsonata","mergecontext":"","output_location":"payload","output_location_type":"none","mustacheAltTags":false,"x":990,"y":220,"wires":[[]]},{"id":"44047d2813574ab2","type":"debug","z":"6a7d13273a282d6b","d":true,"name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","statusVal":"","statusType":"auto","x":1200,"y":220,"wires":[]},{"id":"6d59e03785f36b40","type":"inject","z":"6a7d13273a282d6b","name":"Clear Timer","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"ed375e2fb14f40c79149d1f62ec63d1c","payloadType":"date","x":250,"y":600,"wires":[["171438d024ae506e","812e007a36e62853"]]},{"id":"171438d024ae506e","type":"function","z":"6a7d13273a282d6b","name":"Timer count","func":"var topic_string = \"\"\ntopic_string += \"alexa/timer/alexatimerct\";\nmsg.topic =  topic_string;\n\nvar content_string =  0;\nmsg.payload = content_string;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":600,"wires":[["2a0698ebd103ac77"]]},{"id":"2a0698ebd103ac77","type":"mqtt out","z":"6a7d13273a282d6b","name":"","topic":"","qos":"","retain":"true","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"e620c1bc.88c94","x":590,"y":600,"wires":[]},{"id":"6323d275f11d2bbf","type":"mqtt out","z":"6a7d13273a282d6b","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"e620c1bc.88c94","x":590,"y":640,"wires":[]},{"id":"812e007a36e62853","type":"function","z":"6a7d13273a282d6b","name":"Timer 0 time","func":"var topic_string = \"\"\ntopic_string += \"alexa/timer/kitchen_next_timer\";\nmsg.topic =  topic_string;\n\nvar content_string = 0;\nmsg.payload = content_string;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":430,"y":640,"wires":[["6323d275f11d2bbf"]]},{"id":"6e1d1233516911ac","type":"function","z":"6a7d13273a282d6b","name":"Timer count","func":"var topic_string = \"\"\ntopic_string += \"alexa/timer/alexatimerct\";\nmsg.topic =  topic_string;\n\nvar content_string =  0;\nmsg.payload = content_string;\nreturn msg;\n\n","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":590,"y":140,"wires":[["981ac64072f55c45"]]},{"id":"981ac64072f55c45","type":"mqtt out","z":"6a7d13273a282d6b","name":"","topic":"","qos":"","retain":"true","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"e620c1bc.88c94","x":750,"y":140,"wires":[]},{"id":"fd4557168c61c999","type":"function","z":"6a7d13273a282d6b","name":"","func":"\nmsg.payload = { \n    time: new Date().toLocaleString(\"en-US\", {hour12: false}).replace(\"/\", \"-\").replace(\"/\", \"-\").replace(\", \", \".\")\n};\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":980,"y":600,"wires":[["719f23b4b0eeb71e"]]},{"id":"983d79768a732fe1","type":"inject","z":"6a7d13273a282d6b","name":"","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payloadType":"date","x":830,"y":600,"wires":[["fd4557168c61c999"]]},{"id":"719f23b4b0eeb71e","type":"debug","z":"6a7d13273a282d6b","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload.time","targetType":"msg","statusVal":"","statusType":"auto","x":1160,"y":600,"wires":[]},{"id":"afa37006573a75d8","type":"alexa-remote-account","name":"AmazonLink","authMethod":"proxy","proxyOwnIp":"192.168.0.48","proxyPort":"3456","cookieFile":"/home/pi/Documents/alexa-cookie.json","refreshInterval":"3","alexaServiceHost":"pitangui.amazon.com","amazonPage":"amazon.com","acceptLanguage":"en-US","onKeywordInLanguage":"","userAgent":"","useWsMqtt":"on","autoInit":"on","credentials":{}},{"id":"765c4d0d.672094","type":"ui_group","name":"Timers","tab":"8ed3b3d9.bbfcb","order":1,"disp":true,"width":"6","collapse":false},{"id":"e620c1bc.88c94","type":"mqtt-broker","name":"HASS MQTT","broker":"192.168.0.50","port":"1883","clientid":"","usetls":false,"compatmode":false,"protocolVersion":4,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"70b670b8.ae01a","type":"server","name":"Home Assistant","legacy":false,"addon":false,"rejectUnauthorizedCerts":true,"ha_boolean":"y|yes|true|on|home|open","connectionDelay":true,"cacheJson":true},{"id":"8ed3b3d9.bbfcb","type":"ui_tab","name":"Alexa Timers","icon":"fa-clock-o","order":1,"disabled":false,"hidden":false}]'''
